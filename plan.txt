# Plan: Eliminate XSS Vulnerabilities by Removing innerHTML

## Objective
The goal is to remove all instances of `innerHTML` usage across the application to mitigate Cross-Site Scripting (XSS) vulnerabilities. The design philosophy of "Separation of Concerns" and "Dumb UI" will be preserved.

## Strategy
We will replace string-based HTML generation with programmatic DOM creation. To maintain code readability and developer experience, we will introduce a lightweight DOM utility function (`el`) that allows for declarative-style DOM construction in JavaScript.

## Implementation Steps

### Step 1: Create DOM Utility [COMPLETE]
Create a new file `src/core/dom.js`.
- Implement a helper function `el(tag, attributes, ...children)` (or similar signature).
- This function will:
    - Create an element using `document.createElement(tag)`.
    - Safely set attributes (using `setAttribute` or direct property access).
    - Handle event listeners (e.g., attributes starting with `on`).
    - Safely append children using `appendChild` or `textContent` for strings.
    - Return the created DOM element.

### Step 2: Refactor Shared Utilities & Components [COMPLETE]
Modify shared components to return or append DOM elements instead of HTML strings.
1.  **`src/shared/loader.component.js`**:
    - Refactor `render()` to return an `HTMLElement` instead of a string.
2.  **`src/core/utils.js`**:
    - Review `escapeHtml`. If we switch to `textContent`, explicit escaping might become redundant for many cases, but keep it if used for other contexts.
3.  **`src/shared/modal.component.js`**:
    - Rewrite `_show` to build the modal structure using the `el` helper.
4.  **`src/shared/tag-selector.component.js`** & **`src/shared/sortable-table.component.js`**:
    - Replace `innerHTML` template injection with DOM construction.

### Step 3: Refactor Core Application Structure [COMPLETE]
1.  **`src/App.js`**:
    - Replace `this.element.innerHTML = ...` in `renderLogin` and `renderMainApp` with `this.element.replaceChildren(...)` (or clear and append) using the constructed DOM tree.

### Step 4: Refactor Feature Components
Iterate through each feature and replace `innerHTML` usage.
1.  **Login**: `src/features/login/login.component.js`
2.  **Dashboard**: `src/features/dashboard/dashboard.component.js`
3.  **Transactions**:
    - `transactions.component.js`
    - `transactions.filters.js`
    - `transactions.manual.js` (and modals)
    - `transactions.bulk.js`
    - `split-transaction.modal.js`
    - `transactions.split-history.js`
4.  **Upload**: `src/features/upload/upload.component.js`
5.  **Tags**: `src/features/tags/*` (Component, list, add-trip, details, etc.)
6.  **Analysis**: `src/features/analysis/*` (Component, filters, table, controls, chart)
7.  **Settings**: `src/features/settings/settings.component.js`

### Step 5: Verification
- Search the codebase for any remaining `innerHTML` usages.
- Verify that all components render correctly and functionality remains unchanged.
- Check that event listeners are correctly attached (since we are moving from string-based HTML where listeners might have been attached after `innerHTML` assignment).

## Design Philosophy Check
- **Dumb UI**: Components will still only receive data and render. The rendering method just changes from parsing strings to building nodes.
- **Unidirectional Flow**: State updates will still trigger re-renders.
- **Modularity**: The `el` helper will be a shared utility, keeping components decoupled.
