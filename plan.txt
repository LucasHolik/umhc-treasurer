# Analysis Section Implementation Plan

## Phase 1: Core Logic Implementation

### Step 1: Implement Effective Balance Logic
*   **Action:** Update `AnalysisLogic` in `analysis.logic.js` to add `calculateEffectiveBalance(currentBalance, expenses, tags)`.
*   **Method:**
    1.  Get `TripStatusMap` from the `tags` state.
    2.  Filter `expenses` for transactions where `Trip/Event` exists AND `TripStatusMap[Trip/Event] === 'Active'`.
    3.  Calculate the `Net` sum (Income - Expense) of these active transactions.
    4.  Return `currentBalance - netActiveContribution`.
*   **Goal:** Establish the "Safe-to-Spend" metric foundation.

### Step 2: Implement Comparison Data Logic
*   **Action:** Add `getComparisonData(currentRange, comparisonOffset)` to `AnalysisLogic`.
*   **Method:**
    1.  Accept a date range and an offset (e.g., -1 month, -1 year).
    2.  Fetch and aggregate data for both the current and previous periods.
    3.  Normalize data to a relative index (Day 1-30 or Month 1-12) for side-by-side plotting.
*   **Goal:** Enable period-over-period performance tracking.

### Step 3: Implement Runway Forecasting
*   **Action:** Add `calculateRunway(currentBalance, expenses)` to `AnalysisLogic`.
*   **Method:**
    1.  Calculate average net change over the last 3 months.
    2.  If burn is positive (gaining money), return "Infinite".
    3.  If burn is negative, return `Math.abs(currentBalance / monthlyBurn)`.
*   **Goal:** Provide financial health alerts.

### Step 4: Enhance Aggregation for Drill-Down
*   **Action:** Update `aggregateData` in `AnalysisLogic` to support `drillPath`.
*   **Method:**
    1.  Refactor `aggregateData` to accept a hierarchy array (e.g., `['Type', 'Trip/Event', 'Category']`).
    2.  Dynamically group data based on the current depth of the `drillPath`.
*   **Goal:** Backend support for infinite drill-down UI.

## Phase 2: UI Component Enhancements

### Step 5: Implement Drill-Down Manager & Breadcrumbs
*   **Action:** Create `BreadcrumbComponent` and manage drill-down state in `AnalysisComponent`.
*   **Method:**
    1.  Add state `drillPath` (array of strings) to `AnalysisComponent`.
    2.  Create a visual breadcrumb bar (e.g., `All > Active Trips > Ski Trip`).
    3.  Handle chart clicks to push to `drillPath`, and breadcrumb clicks to slice `drillPath`.

### Step 6: Multi-Line Balance Chart
*   **Action:** Upgrade the main chart in `AnalysisComponent`.
*   **Method:**
    1.  Use `calculateEffectiveBalance` to generate a second dataset.
    2.  Plot "Actual Balance" (Solid) vs "Effective Balance" (Dashed).
    3.  Add a linear regression trend line (Dotted).

### Step 7: Investment Breakeven Dashboard
*   **Action:** Create a sub-component or section for Active Investments.
*   **Method:**
    1.  Filter specifically for `Type === 'Investment'` & `Status === 'Active'`.
    2.  Render a card for each investment showing:
        *   Exposure (Total Spent - Total Returned).
        *   Recovery % Gauge.
        *   Status Color (Red/Yellow/Green).

### Step 8: Seasonality & Heatmaps
*   **Action:** Add a secondary analysis tab or section.
*   **Method:**
    1.  **Seasonality:** Bar chart of aggregated Net Change by Month (Jan-Dec) across all available years.
    2.  **Heatmap:** (Optional) Day-of-Week transaction volume.

## Phase 3: Advanced Features

### Step 9: Save Custom Presets
*   **Action:** Add "Save View" functionality.
*   **Method:**
    1.  Create a modal to name the current view.
    2.  Save the `filterState` and `aggregationState` to `localStorage` under a user-provided name.
    3.  List saved presets for quick loading.

### Step 10: CSV Export
*   **Action:** Add data export capability.
*   **Method:**
    1.  Convert the currently filtered `expenses` array to CSV format.
    2.  Trigger a browser download of the file.
