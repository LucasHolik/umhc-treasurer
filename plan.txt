# Analysis Section Implementation Plan

## Phase 1: Core Logic & Data Structure
**Goal:** Ensure the backend logic supports robust filtering (especially by Trip Status) and flexible multi-level grouping.

### Step 1: Logic & Skeleton (Completed)
*   *Status:* **Done**.
*   *Details:* Basic component structure and `analysis.logic.js` foundation are in place.

### Step 1.5: Financial Logic Alignment
*   *Status:* **Completed**.
*   *Objective:* Ensure consistency with core financial calculations.
*   *Action:* Verify that all "Balance" and "Net" calculations in `analysis.logic.js` strictly adhere to the patterns in `src/core/financial.logic.js`.
*   *Outcome:* Logic verified. `adjustedOpeningBalance` is used correctly. Manual transactions are effectively neutral to the running balance start point (offset + transaction cancellation) but appear correctly in the timeline.

### Step 2: Trip Status Integration
*   *Status:* **Completed**.
*   **Objective:** Enable filtering expenses based on whether their associated Trip/Event is "Active" or "Completed".
*   **Action:**
    *   Update `analysis.logic.js` to ingest `tags` state (specifically the `Trip/Event` status map).
    *   Add a helper to determine if a transaction belongs to a "Completed" or "Active" trip.
    *   Add `tripStatus` ('Active', 'Completed', 'All') as a filter parameter in `getFilteredData`.

### Step 3: Advanced Grouping Logic
*   *Status:* **Completed**.
*   **Objective:** Support the "Overarching Tag + Subtag" requirement (e.g., Spending by Category, subdivided by Trip).
*   **Action:**
    *   Refine `aggregateData` in `analysis.logic.js` to handle any combination of two grouping dimensions (e.g., Primary: Category, Secondary: Trip).
    *   Ensure "Net Spend" (Income - Expense) is calculated correctly for these groups.
    *   *Outcome:* Verified with test script. Logic handles arbitrary primary/secondary grouping and net calculations correctly.

## Phase 2: Feature Implementation (The "Big 3")

### Step 4: "Completed Trips" Analysis
*   *Status:* **Completed**.
*   **Objective:** Easily see the net spend on trips that have finished.
*   **UI Change:** Add a "Trip Status" dropdown to the controls (default to 'Active' or 'All' depending on context, but allow 'Completed').
*   **Visualization:** Standardize on a **Bar Chart** for this view.
*   **Logic:**
    *   Filter: `tripStatus = 'Completed'`.
    *   Metric: `Net` (or `Expense` if preferred).
    *   Group By: `Trip/Event`.

### Step 5: Hierarchical Tag Grouping
*   **Objective:** See spend grouped by an overarching tag and then a subtag.
*   **UI Change:** Refactor Grouping Dropdowns.
    *   Rename "Primary Grouping" to **"Main Category (X-Axis)"**.
    *   Rename "Secondary Grouping" to **"Sub-Category (Stacks)"**.
    *   Ensure options allow all combinations: Date, Category, Trip/Event.
*   **Action:** Verify that "Category" (Main) x "Trip" (Sub) and "Trip" (Main) x "Category" (Sub) render correctly.

### Step 6: Presets System
*   **Objective:** "Click and easy see" implementation.
*   **Action:**
    *   Refine the "Quick Reports" buttons to map to specific, useful configurations.
    *   **Proposed Presets:**
        1.  **"Trip Cost (Completed)"**: Shows Net Spend of all completed trips (Bar Chart).
        2.  **"Category Breakdown"**: Shows Expenses grouped by Category, stacked by Trip (Bar Chart).
        3.  **"Monthly Trend"**: Shows Net Income over time (Line/Bar).
        4.  **"Active Trip Status"**: Current spend on ongoing trips.

## Phase 3: UI Polish & Refinement

### Step 7: Dropdown & Control Cleanup
*   **Objective:** "Most of the drop down options should change."
*   **Action:**
    *   Streamline the control panel.
    *   Group controls logically:
        1.  **Scope:** Timeframe + Trip Status (Active/Completed).
        2.  **View:** Preset Buttons (Prominent).
        3.  **Customization:** The Grouping/Metric dropdowns (maybe less prominent or organized below).
    *   Remove redundant or confusing options.

### Step 8: Visualization Enhancements
*   **Objective:** Make the graphs beautiful and readable.
*   **Action:**
    *   Improve tooltips to show the "Sub-Category" details clearly.
    *   Ensure consistent color palette for Categories/Trips.